<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Pickleball Viewer – JSON + Images</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 8px 12px;
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      background: #111;
      border-bottom: 1px solid #333;
    }

    .table-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
      background: #000;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      font-size: 15px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #222;
      z-index: 10;
    }

    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    tbody tr:nth-child(even) td {
      background: #151515;
    }
    tbody tr:nth-child(odd) td {
      background: #050505;
    }

    td.name, th.name {
      text-align: left;
    }

    td.last-col, th.last-col {
      width: 80px;
    }

    td.last-col img {
      max-width: 60px;
      max-height: 60px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    .footer {
      padding: 6px 10px;
      font-size: 12px;
      background: #111;
      border-top: 1px solid #333;
      display: flex;
      justify-content: space-between;
      color: #ccc;
    }
  </style>
</head>

<body>
  <div class="header">BẢNG XẾP HẠNG PICKLEBALL</div>

  <div id="table-container" class="table-container">
    <table id="ranking-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">
    <div>Auto update từ Google Sheets</div>
    <div id="last-updated">Đang tải...</div>
  </div>

<script>
  // ⭐ API Apps Script của bạn (đã dùng URL bạn gửi)
  const API_URL = "https://script.google.com/macros/s/AKfycbwGTNySpFkDv0q19ykb5SeFg0BmTY4d7vCc6DIRu26fP2MV7bupxDbBPL8T1slopgIdLw/exec";

  // Thời gian refresh (ms). 5000 = 5 giây
  const REFRESH_MS = 5000;

  const container = document.getElementById("table-container");
  const table = document.getElementById("ranking-table");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const updatedEl = document.getElementById("last-updated");

  async function fetchData() {
    const res = await fetch(API_URL + "?t=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("Lỗi: " + res.status);
    const payload = await res.json();   // { range: {...}, data: [...] }
    return payload.data || [];
  }

  function renderTable(data) {
    thead.innerHTML = "";
    tbody.innerHTML = "";
    if (!data || data.length === 0) return;

    // Hàng đầu tiên là header
    const headerRow = document.createElement("tr");
    data[0].forEach((cell, idx) => {
      const th = document.createElement("th");
      const text = cell && cell.text ? cell.text : "";
      th.textContent = text;
      if (idx === 1) th.classList.add("name");               // cột 2: tên
      if (idx === data[0].length - 1) th.classList.add("last-col"); // cột cuối: ảnh/QR
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    // Các hàng còn lại là dữ liệu
    for (let r = 1; r < data.length; r++) {
      const row = data[r];
      if (!row) continue;

      const tr = document.createElement("tr");

      row.forEach((cell, idx) => {
        const td = document.createElement("td");
        const text = cell && cell.text ? cell.text : "";
        const imgs = (cell && cell.imageUrls) ? cell.imageUrls : [];

        if (imgs.length > 0) {
          // Có ảnh → hiển thị ảnh, text (nếu có) dưới ảnh
          const img = document.createElement("img");
          img.src = imgs[0];
          td.appendChild(img);

          if (text) {
            const span = document.createElement("div");
            span.textContent = text;
            span.style.fontSize = "11px";
            td.appendChild(span);
          }
        } else {
          td.textContent = text;
        }

        if (idx === 1) td.classList.add("name");
        if (idx === row.length - 1) td.classList.add("last-col");

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }

    updatedEl.textContent = "Cập nhật: " + new Date().toLocaleTimeString("vi-VN");
  }

  async function loadData() {
    const prevScrollTop = container.scrollTop;

    try {
      const data = await fetchData();
      renderTable(data);
      container.scrollTop = prevScrollTop; // giữ nguyên vị trí cuộn
    } catch (err) {
      console.error(err);
      updatedEl.textContent = "Lỗi tải dữ liệu...";
    }
  }

  loadData();
  setInterval(loadData, REFRESH_MS);
</script>
</body>
</html>
